@page "/users"
@inject APIClient APIClient
@inject AuthenticationStateProvider AuthProvider


<PageTitle>Users</PageTitle>

<MudText Typo="Typo.h3" GutterBottom="true">-Admin-</MudText>
<MudText Typo="Typo.body1" Class="mb-8">Edit users.</MudText>

@if (users == null)
{
    <MudProgressCircular Color="Color.Default" Indeterminate="true" />
}
else
{
    <MudTable Items="users" Hover="true" SortLabel="Sort By" Elevation="0" AllowUnsorted="false">
        <HeaderContent>
            <MudTh><MudTableSortLabel InitialDirection="SortDirection.Ascending" SortBy="new Func<UserDTO, object>(x=>x.Username)">Username</MudTableSortLabel></MudTh>
            <MudTh><MudTableSortLabel SortBy="new Func<UserDTO, object>(x=>x.Role)">Role</MudTableSortLabel></MudTh>
            <MudTh><MudTableSortLabel SortBy="new Func<UserDTO, object>(x=>x.Password)">Password</MudTableSortLabel></MudTh>
            <MudTh><MudTableSortLabel SortBy="new Func<UserDTO, object>(x=>x.Email)">Email</MudTableSortLabel></MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Username">@context.Username</MudTd>
            <MudTd DataLabel="Role">@context.Role</MudTd>
            <MudTd DataLabel="Password">@context.Password</MudTd>
            <MudTd DataLabel="Email">@context.Email</MudTd>
            @if (isAdmin)
            {
                <MudTd><MudButton >Status</MudButton></MudTd>
                <MudTd><MudButton>Edit</MudButton></MudTd>
                <MudTd><MudButton>Delete</MudButton></MudTd>
            }
        </RowTemplate>
        <PagerContent>
            <MudTablePager PageSizeOptions="new int[]{50, 100}" />
        </PagerContent>
    </MudTable>
}

@code {

    private List<UserDTO> users = new List<UserDTO>();
    private bool isAdmin;
    protected override async Task OnInitializedAsync()
    {

        users = await APIClient.GetFromJsonAsync<List<UserDTO>>("https://localhost:7218/api/Auth");

        var authState = await AuthProvider.GetAuthenticationStateAsync();
        isAdmin = authState.User.IsInRole("Admin");
        StateHasChanged();
    }

    // public async Task SetStatus(string id)
    // {
    //     var productToUpdate = products.FirstOrDefault(p => p.ProductId == id);
    //     if (productToUpdate != null)
    //     {
    //         productToUpdate.Status = !productToUpdate.Status; // Assuming Status is a boolean (toggle availability)

    //         await APIClient.PutAsync<string, ProductDTO>($"https://localhost:7218/api/Product/status/{id}", productToUpdate);

    //         Snackbar.Add($"Status on product: {productToUpdate.ProductName} is now : {productToUpdate.Status}", Severity.Success);

    //         StateHasChanged();
    //     }
    // }


    public async Task DeleteUser(string id)
    {
        var parameters = new DialogParameters
        {
            { "ContentText", "Are you sure you want to delete this product? This action cannot be undone." },
            { "ButtonText", "Delete" },
            { "Color", Color.Error }
        };

        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.ExtraSmall };

        var dialog = await DialogService.ShowAsync<ConfirmDeleteDialog>("Confirm Delete", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            try
            {
                bool deleteSuccess = await APIClient.DeleteAsync($"https://localhost:7218/api/Product/{id}");

                if (deleteSuccess)
                {
                    products = await APIClient.GetFromJsonAsync<List<ProductDTO>>("https://localhost:7218/api/Product");
                    StateHasChanged();
                }
            }
            catch (HttpRequestException ex)
            {
                Snackbar.Add($"Error deleting product: {ex.Message}", Severity.Success);
            }
        }
    }


    public async Task UpdateProduct(ProductDTO updatedProduct)
    {
        var parameters = new DialogParameters
    {
        { "product", updatedProduct }
    };


        var dialog = await DialogService.ShowAsync<UpdateDialog>("Update Product", parameters);
        var result = await dialog.Result;


    }



}
